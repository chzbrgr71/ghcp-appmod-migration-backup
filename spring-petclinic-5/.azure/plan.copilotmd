# Azure Deployment Plan for spring-petclinic Project

## **Goal**
Deploy the Spring PetClinic application to existing Azure Kubernetes Service (AKS) in resource group `briar-aks` and subscription `24a4c592-bfaf-492f-beaf-f10b3b67f03f` using Azure CLI.

## **Project Information**

**Spring PetClinic Application**
- **Stack**: Java 17, Spring Boot 4.0.0-M3, Maven
- **Type**: Web application for managing pet clinic operations (Thymeleaf UI + REST API)
- **Framework**: Spring Framework with JPA/Hibernate for data persistence
- **Containerization**: Dockerfile present (multi-stage build with Maven 3.9 and JDK 25 for build, JRE 17 for runtime)
- **Dependencies**: 
  - Azure Database for PostgreSQL (with passwordless authentication via Managed Identity)
  - Azure Container Registry (for storing container images)
- **Hosting**: Azure Kubernetes Service (AKS)
- **Port**: 8080
- **Database**: PostgreSQL with Azure Managed Identity authentication enabled
- **Kubernetes Manifests**: Existing manifests in `k8s/` directory

## **Azure Resources Architecture**
> **Install the mermaid extension in IDE to view the architecture.**

```mermaid
graph TD
%% Services
svcazurekubernetesservice_petclinic["`Name: petclinic
Path: src/main/java/org/springframework/samples/petclinic
Language: java
Port: 8080`"]
subgraph "Compute Resources"
%% Resources
subgraph akscluster["Azure Kubernetes Service (AKS) Cluster"]
azurekubernetesservice_petclinic("`petclinic (Containerized Service)`")
end
akscluster:::cluster
end
subgraph "Dependency Resources"
%% Dependency Resources
azuredatabaseforpostgresql_dbpetclinic14db["`db-petclinic14db (Azure Database for PostgreSQL)`"]
azurecontainerregistry_acrpetclinic14dbb6["`acrpetclinic14dbb6 (Azure Container Registry)`"]
end
%% Relationships
svcazurekubernetesservice_petclinic --> |"hosted on"| azurekubernetesservice_petclinic
azurekubernetesservice_petclinic -.-> |"user-identity"| azuredatabaseforpostgresql_dbpetclinic14db
azurekubernetesservice_petclinic -.-> |"system-identity"| azurecontainerregistry_acrpetclinic14dbb6
```

## **Existing Azure Resources**

| Resource Type | Name | SKU | Purpose | 
|---------------|------|-----|--------|
| Azure Kubernetes Service | briar-aks | Free (Base) | Container orchestration platform for hosting the application |
| PostgreSQL Flexible Server | db-petclinic14db | Standard_B1ms (Burstable) | Database backend with existing 'petclinic' database |
| Container Registry | acrpetclinic14dbb6 | Basic | Container image storage and distribution |
| Managed Identity | mi-petclinic | N/A | Passwordless authentication to PostgreSQL |

**Missing Resources**: None - All required resources exist

## **Execution Steps**
> **Below are the steps for Copilot to follow; ask Copilot to update or execute this plan.**

### 1. Environment Setup for Azure CLI
   - [ ] Verify Azure CLI is installed
   - [ ] Verify current subscription is set to `24a4c592-bfaf-492f-beaf-f10b3b67f03f`
   - [ ] Verify kubectl is installed for AKS deployment
   - [ ] Get AKS credentials: `az aks get-credentials --resource-group briar-aks --name briar-aks`

### 2. Containerization
   - [ ] Verify Dockerfile exists at `/Users/brianredmond/source/migration-demo/spring-petclinic-5/Dockerfile`
   - [ ] Review Dockerfile configuration (multi-stage build detected)
   - [ ] Build Docker image locally or use ACR build task
   - **Output**: Container image ready for deployment

### 3. Azure Container Registry (ACR) Setup
   - [ ] Login to ACR: `az acr login --name acrpetclinic14dbb6`
   - [ ] Tag image for ACR: `docker tag <image> acrpetclinic14dbb6.azurecr.io/petclinic:latest`
   - [ ] Push image to ACR or use ACR build: `az acr build --registry acrpetclinic14dbb6 --image petclinic:latest .`
   - **Output**: Image available in ACR

### 4. Database Configuration
   - [ ] Verify PostgreSQL database `petclinic` exists on `db-petclinic14db`
   - [ ] Verify Managed Identity `mi-petclinic` has access to PostgreSQL
   - [ ] Get PostgreSQL FQDN: `db-petclinic14db.postgres.database.azure.com`
   - [ ] Configure connection string for application
   - **Output**: Database connection details ready

### 5. Kubernetes Manifest Preparation
   - [ ] Review existing Kubernetes manifests in `k8s/` directory
   - [ ] Update `k8s/petclinic.yml` with:
     - Correct ACR image path: `acrpetclinic14dbb6.azurecr.io/petclinic:latest`
     - PostgreSQL connection details
     - Managed Identity configuration for workload identity
     - Environment variables for Spring profiles (postgres)
   - [ ] Create/update Kubernetes secrets for database connection if needed
   - **Output**: Updated Kubernetes YAML files

### 6. AKS Deployment
   - [ ] Attach ACR to AKS (if not already): `az aks update --resource-group briar-aks --name briar-aks --attach-acr acrpetclinic14dbb6`
   - [ ] Configure workload identity for PostgreSQL access
   - [ ] Apply Kubernetes manifests: `kubectl apply -f k8s/`
   - [ ] Verify deployment status: `kubectl get deployments`
   - [ ] Verify pods are running: `kubectl get pods`
   - [ ] Check pod logs for any issues: `kubectl logs <pod-name>`
   - **Output**: Application deployed to AKS

### 7. Service Exposure and Testing
   - [ ] Get service details: `kubectl get services`
   - [ ] Get external IP or configure ingress if needed
   - [ ] Test application endpoint: `curl http://<service-ip>/actuator/health`
   - [ ] Verify database connectivity through application
   - **Output**: Application accessible and functional

### 8. Deployment Validation
   - [ ] Verify all pods are in Running state
   - [ ] Check application logs for startup success
   - [ ] Test health endpoints (liveness/readiness probes)
   - [ ] Verify database connection is working
   - [ ] Access application UI and test basic functionality
   - **Output**: Fully functional application

### 9. Summarize Deployment Result
   - [ ] Use `appmod-summarize-result` tool to generate deployment summary
   - [ ] Document any configuration changes made
   - [ ] Output: `.azure/summary.copilotmd`

## **Progress Tracking**
Copilot will create and update `.azure/progress.copilotmd` after each step with:
- ‚úÖ Completed tasks
- üî≤ Pending tasks  
- ‚ùå Failed tasks with error notes and retry attempts

If any step fails, the error will be logged, scripts/configurations will be fixed, and deployment will be retried until successful.
